<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŸã¹ã‚­ãƒªï¼ - DEMO</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        /* --- CSS ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        :root {
            --primary: #FF9F43; --secondary: #2ECC71; --bg: #fffbf0;
            --text: #5d4037; --accent: #FF6B6B; --admin-color: #5f27cd;
            --gold: #f1c40f;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg); color: var(--text); margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
            padding-bottom: 70px; /* ã‚¿ãƒ–ãƒãƒ¼ã®åˆ† */
        }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            background-color: white; width: 100%; padding: 10px 0; text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 500;
            display: flex; justify-content: center; align-items: center; gap: 10px; cursor: pointer; user-select: none;
        }
        h1 { margin: 0; color: var(--primary); font-size: 20px; }
        .header-icon { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .demo-badge { font-size:10px; background:var(--accent); color:white; padding:2px 6px; border-radius:4px; margin-left:5px; animation:blink 2s infinite;}
        @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.5;} }

        /* é€šçŸ¥ãƒãƒŠãƒ¼ */
        #notification-banner {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background-color: var(--accent); color: white; padding: 10px 20px;
            border-radius: 30px; box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
            font-weight: bold; z-index: 2000; transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; align-items: center; gap: 10px; width: max-content; white-space: nowrap;
        }
        .banner-icon { width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; object-fit: cover;}

        /* å®Ÿç¸¾ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ */
        #dashboard {
            width: 90%; max-width: 600px; background: white; margin: 15px 0; padding: 15px;
            border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex; justify-content: space-around; align-items: center;
            background: linear-gradient(135deg, #fff, #fff8e1); position: relative;
        }
        .stat-box { text-align: center; }
        .stat-value { font-size: 20px; font-weight: bold; color: var(--primary); display: block; }
        .stat-label { font-size: 10px; color: #888; }
        
        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¡¨ç¤º */
        .user-greeting { position: absolute; top: -25px; left: 10px; font-size: 12px; font-weight: bold; color: var(--text); }
        .btn-invite { background: var(--text); color: white; border: none; padding: 6px 12px; border-radius: 20px; font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 5px; }

        /* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒªã‚¢ */
        .tab-content { width: 100%; max-width: 600px; display: none; flex-direction: column; align-items: center;}
        .tab-content.active { display: flex; }

        /* ãƒãƒƒãƒ— */
        #map-container { width: 100%; height: 250px; background: #ddd; position: relative; z-index: 1; margin-bottom: 20px;}
        #map { width: 100%; height: 100%; }

        /* å•†å“ã‚«ãƒ¼ãƒ‰ */
        .card-list { width: 90%; display: grid; gap: 15px; }
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); position: relative; transition: all 0.3s; }
        .card.is-kept { border: 2px solid var(--primary); background: #fffbf0; }
        .card.new-item { animation: slideDown 0.5s ease forwards; }
        @keyframes slideDown { from{opacity:0; transform:translateY(-20px);} to{opacity:1; transform:translateY(0);} }
        
        .badge-off { position: absolute; top: -8px; left: -8px; z-index: 10; background: var(--accent); color: white; padding: 4px 8px; border-radius: 12px; font-weight: bold; font-size: 12px; }
        .carousel { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 10px; margin-bottom: 10px; border-radius: 8px; }
        .carousel img { flex: 0 0 100%; height: 150px; object-fit: cover; border-radius: 8px; scroll-snap-align: start; }
        .carousel::-webkit-scrollbar { display: none; }

        .card-content-row { display: flex; justify-content: space-between; align-items: center; margin-top: 5px;}
        .food-info { flex: 1; display: flex; align-items: center; gap: 10px; }
        .emoji { font-size: 28px; background: #f0f0f0; border-radius: 50%; width: 40px; height: 40px; display:flex; align-items:center; justify-content:center; flex-shrink: 0;}
        .details h3 { margin: 0; font-size: 16px; }
        .shop-address { font-size: 10px; color: #999; display: block; }
        .coupon-tag { font-size: 10px; background: #e0f7fa; color: #006064; padding: 2px 6px; border-radius: 4px; display:inline-block; margin-top:3px;}
        
        .btn-group { display: flex; flex-direction: column; gap: 5px; margin-left: 10px;}
        button { border: none; padding: 6px 10px; border-radius: 20px; cursor: pointer; font-weight: bold; color: white; font-size: 11px; width: 80px;}
        .btn-buy { background-color: var(--primary); }
        .btn-eat { background-color: var(--secondary); }
        button:disabled { background-color: #eee; color: #aaa; cursor: not-allowed; }

        /* ã‚¯ãƒ¼ãƒãƒ³ä¸€è¦§ */
        .ticket {
            background: linear-gradient(135deg, #fff, #fff0f6);
            border: 2px dashed var(--accent); border-radius: 10px;
            padding: 15px; margin-bottom: 15px; width: 90%; position: relative;
            display: flex; justify-content: space-between; align-items: center; overflow: hidden;
        }
        .ticket::before { content: ''; position: absolute; top: -10px; right: -10px; width: 80px; height: 80px; background: url('ururu.jpg') no-repeat center/cover; opacity: 0.15; transform: rotate(15deg); border-radius: 50%; }
        .ticket-info h3 { margin: 0; font-size: 16px; color: var(--text); }
        .ticket-shop { font-size: 12px; color: #888; }
        .ticket-offer { font-size: 18px; font-weight: bold; color: var(--accent); margin: 5px 0; }
        .ticket-exp { font-size: 10px; color: #aaa; }
        .btn-use { background: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 20px; z-index: 2; cursor: pointer;}

        /* å±¥æ­´ */
        .history-item { background: white; border-bottom: 1px solid #eee; padding: 15px; width: 90%; display: flex; justify-content: space-between; align-items: center; }
        .history-stars { color: var(--gold); font-size: 12px; }
        .history-date { font-size: 10px; color: #aaa; }

        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚° */
        .ranking-item { background: white; width: 90%; padding: 15px; margin-bottom: 10px; border-radius: 10px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .rank-num { font-size: 20px; font-weight: bold; width: 30px; text-align: center; color: var(--primary);}
        .rank-user { flex: 1; font-weight: bold; }
        .rank-score { font-weight: bold; color: var(--secondary); }
        .rank-you { border: 2px solid var(--primary); background: #fff8e1; }
        .btn-add-friend { background: #333; color: white; padding: 10px 20px; border-radius: 20px; margin-bottom: 20px; cursor: pointer; }

        /* ä¸‹éƒ¨ã‚¿ãƒ–ãƒãƒ¼ */
        .tab-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
        .tab-btn { display: flex; flex-direction: column; align-items: center; color: #aaa; cursor: pointer; font-size: 10px; }
        .tab-btn i { font-size: 20px; margin-bottom: 3px; }
        .tab-btn.active { color: var(--primary); }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 3000; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; text-align: center; width: 85%; max-width: 350px; position: relative; animation: popIn 0.3s ease; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .rating-area { margin: 15px 0; font-size: 24px; color: #ddd; cursor: pointer; }
        .rating-area span:hover, .rating-area span.checked { color: var(--gold); }
        #scanner-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:4000; flex-direction:column; align-items:center; justify-content:center; color:white;}
        #reader { width: 300px; height: 300px; background: #000; }
        /* ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #account-modal { display: none; z-index: 5000; background: rgba(0,0,0,0.8); }

        .input-group { margin-bottom: 10px; text-align: left; width: 100%;}
        .input-group label { display: block; font-weight: bold; font-size: 12px;}
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }

    </style>
</head>
<body>

    <header id="app-header">
        <img src="ururu.jpg" class="header-icon" onerror="this.style.display='none'">
        <h1 id="app-title">ãŸã¹ã‚­ãƒªï¼<span class="demo-badge">DEMO</span></h1>
    </header>

    <div id="notification-banner">
        <img src="ururu.jpg" class="banner-icon" onerror="this.style.display='none'">
        <span id="banner-text"></span>
    </div>

    <div id="tab-home" class="tab-content active">
        <div class="user-greeting">ã“ã‚“ã«ã¡ã¯ã€<span id="user-name-display">ã‚²ã‚¹ãƒˆ</span>ã•ã‚“</div>
        <div id="dashboard" style="margin-top:25px;">
            <div class="stat-box">
                <span class="stat-label">ãƒ¬ã‚¹ã‚­ãƒ¥ãƒ¼æ•°</span>
                <span class="stat-value" id="disp-count">0</span>
            </div>
            <div class="stat-box">
                <span class="stat-label">ç¯€ç´„é¡</span>
                <span class="stat-value" id="disp-money">0å††</span>
            </div>
            <button class="btn-invite" onclick="inviteFriend()">
                <i class="fas fa-paper-plane"></i> æ‹›å¾…
            </button>
        </div>

        <div id="map-container"><div id="map"></div></div>
        <div id="user-view" class="card-list"></div>
    </div>

    <div id="tab-coupon" class="tab-content">
        <h2 style="color:var(--text); font-size:18px; margin:20px 0;">ğŸŸï¸ ãƒã‚¤ã‚¯ãƒ¼ãƒãƒ³</h2>
        <div id="coupon-list" style="width:100%; display:flex; flex-direction:column; align-items:center;">
            <p style="color:#aaa; font-size:12px;">ã¾ã ã‚¯ãƒ¼ãƒãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</p>
        </div>
    </div>

    <div id="tab-history" class="tab-content">
        <h2 style="color:var(--text); font-size:18px; margin:20px 0;">ğŸ“œ ãƒ¬ã‚¹ã‚­ãƒ¥ãƒ¼å±¥æ­´</h2>
        <div id="history-list" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
    </div>

    <div id="tab-ranking" class="tab-content">
        <h2 style="color:var(--text); font-size:18px; margin:20px 0;">ğŸ† å‹é”ã¨ç«¶äº‰</h2>
        <button class="btn-add-friend" onclick="addFriend()">â• å‹é”ã‚’è¿½åŠ ã™ã‚‹</button>
        <div id="ranking-list" style="width:100%; display:flex; flex-direction:column; align-items:center;">
            </div>
    </div>

    <div id="admin-view" class="tab-content" style="background:white; padding:20px; box-sizing:border-box;">
        <h2 style="color:var(--admin-color);">ğŸ‘¨â€ğŸ³ åº—é•·ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
        <button onclick="startScanner()" style="background:#333; color:white; padding:10px; width:100%; margin-bottom:20px;">ğŸ“· QRã‚¹ã‚­ãƒ£ãƒ³</button>
        
        <h3>å•†å“è¿½åŠ </h3>
        <div class="input-group"><label>ä½æ‰€</label><input type="text" id="input-address"></div>
        <div class="input-group"><label>åº—å</label><input type="text" id="input-shop"></div>
        <div class="input-group"><label>å•†å“å</label><input type="text" id="input-name"></div>
        <div class="input-group"><label>ã‚¯ãƒ¼ãƒãƒ³å</label><input type="text" id="input-coupon-title" placeholder="ãŠè“å­ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ"></div>
        <div class="input-group"><label>ä¾¡æ ¼(å®šä¾¡ -> å‰²å¼•)</label>
            <div style="display:flex; gap:10px;"><input type="number" id="input-old"><input type="number" id="input-new"></div>
        </div>
        <button onclick="addNewProduct()" style="background:var(--admin-color); width:100%; padding:12px;">ç™»éŒ²</button>
    </div>

    <div class="tab-bar">
        <div class="tab-btn active" onclick="switchTab('home')"><i class="fas fa-home"></i>ãƒ›ãƒ¼ãƒ </div>
        <div class="tab-btn" onclick="switchTab('coupon')"><i class="fas fa-ticket-alt"></i>ã‚¯ãƒ¼ãƒãƒ³</div>
        <div class="tab-btn" onclick="switchTab('history')"><i class="fas fa-history"></i>å±¥æ­´</div>
        <div class="tab-btn" onclick="switchTab('ranking')"><i class="fas fa-crown"></i>é †ä½</div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title"></h2><p id="modal-text"></p>
            <div id="rating-stars" class="rating-area" style="display:none;">
                <span onclick="setRating(1)">â˜…</span><span onclick="setRating(2)">â˜…</span><span onclick="setRating(3)">â˜…</span><span onclick="setRating(4)">â˜…</span><span onclick="setRating(5)">â˜…</span>
            </div>
            <div id="qr-area" style="margin:20px 0; display:none;">
                <div id="qrcode"></div><p style="font-size:10px; color:#aaa;">åº—å“¡ã•ã‚“ã«è¦‹ã›ã¦ãã ã•ã„</p>
            </div>
            <button id="modal-btn" style="background:var(--primary); width:100%; padding:10px; font-size:14px;">OK</button>
        </div>
    </div>

    <div id="account-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <h2 style="color:var(--primary);">ã‚ˆã†ã“ãï¼</h2>
            <p>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’æ•™ãˆã¦ãã ã•ã„</p>
            <input type="text" id="input-nickname" placeholder="ä¾‹: ãŸã¹ã‚­ãƒªå¤ªéƒ" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:5px; margin:10px 0;">
            <button onclick="registerAccount()" style="background:var(--secondary); color:white; width:100%; padding:10px;">ã¯ã˜ã‚ã‚‹</button>
        </div>
    </div>

    <div id="scanner-modal">
        <h3>QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</h3><div id="reader"></div>
        <button onclick="stopScanner()" style="margin-top:20px; background:white; color:black;">é–‰ã˜ã‚‹</button>
    </div>

    <script>
        // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
        let userName = localStorage.getItem('tb_username');
        let userStats = JSON.parse(localStorage.getItem('tb_stats')) || { count: 0, money: 0 };
        let myCoupons = JSON.parse(localStorage.getItem('tb_coupons')) || []; 
        let myHistory = JSON.parse(localStorage.getItem('tb_history')) || []; 
        let myFriends = JSON.parse(localStorage.getItem('tb_friends')) || [
            {name: "ãŸã¹ã‚­ãƒªç¥", count: 128}, {name: "ã‚¨ã‚³ç•ªé•·", count: 85}, {name: "ã®ãã¿", count: 42}
        ]; // åˆæœŸå‹é”(ãƒ€ãƒŸãƒ¼)
        
        let currentKept = 0; 
        let userLat = 35.8285, userLng = 139.7214; 
        const map = L.map('map').setView([userLat, userLng], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);
        let markers = [];

        window.onload = function() {
            // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
            if (!userName) {
                document.getElementById('account-modal').style.display = 'flex';
            } else {
                document.getElementById('user-name-display').innerText = userName;
            }

            updateDashboard();
            renderCoupons();
            renderHistory();
            renderRanking();
            
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    userLat = pos.coords.latitude; userLng = pos.coords.longitude;
                    map.setView([userLat, userLng], 13);
                    L.marker([userLat, userLng], {icon: L.divIcon({className: 'my-loc', html: '<div style="background:blue; width:12px; height:12px; border-radius:50%; border:2px solid white;"></div>'})}).addTo(map).bindPopup("ç¾åœ¨åœ°");
                    L.circle([userLat, userLng], { radius: 5000, color: '#3388ff', fillOpacity: 0.1 }).addTo(map);
                }, () => {});
            }
            startAutoDemo();
        };

        // --- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ² ---
        function registerAccount() {
            const name = document.getElementById('input-nickname').value;
            if(!name) return alert("åå‰ã‚’å…¥ã‚Œã¦ã­");
            userName = name;
            localStorage.setItem('tb_username', userName);
            document.getElementById('user-name-display').innerText = userName;
            document.getElementById('account-modal').style.display = 'none';
            renderRanking(); // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®åå‰ã‚‚æ›´æ–°
        }

        // --- å‹é”è¿½åŠ æ©Ÿèƒ½ ---
        function addFriend() {
            const friendName = prompt("å‹é”ã®åå‰ã‚’å…¥åŠ›ã—ã¦è¿½åŠ ï¼");
            if(friendName) {
                // è‡ªåˆ†ã«è¿‘ã„ã‚¹ã‚³ã‚¢ã‚’ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã—ã¦ç«¶äº‰æ„Ÿã‚’å‡ºã™
                const randomScore = Math.floor(Math.random() * 20) + Math.max(0, userStats.count - 5);
                myFriends.push({ name: friendName, count: randomScore });
                localStorage.setItem('tb_friends', JSON.stringify(myFriends));
                renderRanking();
                alert(`${friendName}ã•ã‚“ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼\nè² ã‘ãªã„ã‚ˆã†ã«é ‘å¼µã‚ã†ï¼`);
            }
        }

        // --- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º ---
        function renderRanking() {
            const list = document.getElementById('ranking-list');
            const myData = { name: userName || "ã‚ãªãŸ", count: userStats.count, isMe: true };
            // å‹é”ãƒªã‚¹ãƒˆã¨è‡ªåˆ†ã‚’çµåˆã—ã¦ã‚½ãƒ¼ãƒˆ
            let all = [...myFriends, myData].sort((a,b) => b.count - a.count);
            
            list.innerHTML = "";
            all.forEach((u, i) => {
                const cls = u.isMe ? "ranking-item rank-you" : "ranking-item";
                const medal = i===0 ? 'ğŸ¥‡' : i===1 ? 'ğŸ¥ˆ' : i===2 ? 'ğŸ¥‰' : '';
                list.innerHTML += `
                    <div class="${cls}">
                        <div class="rank-num">${medal || i+1}</div>
                        <div class="rank-user">${u.name}</div>
                        <div class="rank-score">${u.count}å›</div>
                    </div>
                `;
            });
        }

        // --- æ‹›å¾…æ©Ÿèƒ½ (å¾©æ´») ---
        function inviteFriend() {
            const text = `é£Ÿå“ãƒ­ã‚¹å‰Šæ¸›ã‚¢ãƒ—ãƒªã€ŒãŸã¹ã‚­ãƒªï¼ã€\nç§(${userName})ã¨ä¸€ç·’ã«ç«¶ã„åˆãŠã†ï¼\nã“ã“ã‹ã‚‰å§‹ã‚ã¦ã­ ğŸ‘‡`;
            const url = window.location.href;
            if (navigator.share) {
                navigator.share({ title: 'ãŸã¹ã‚­ãƒªï¼', text: text, url: url }).catch(()=>{});
            } else {
                alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼å‹é”ã«é€ã£ã¦ã­\n" + url);
            }
        }

        // --- ä»¥ä¸‹ã€æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ ---
        function updateDashboard() {
            document.getElementById('disp-count').innerText = userStats.count;
            document.getElementById('disp-money').innerText = userStats.money.toLocaleString() + "å††";
        }
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; const Ï†1 = lat1 * Math.PI/180, Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180, Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        function addProduct(item, isAuto=false) {
            const dist = getDistance(userLat, userLng, item.lat, item.lng);
            if(dist > 5000) return;
            const card = document.createElement('div');
            card.className = isAuto ? 'card new-item' : 'card';
            card.itemData = item; 
            const percent = Math.floor(((item.oldPrice - item.newPrice) / item.oldPrice) * 100);
            let imgHTML = '';
            if(item.images && item.images.length) { imgHTML = `<div class="carousel">${item.images.map(u=>`<img src="${u}">`).join('')}</div>`; }
            card.innerHTML = `
                <div class="badge-off">${percent}% OFF</div> ${imgHTML}
                <div class="card-content-row">
                    <div class="food-info">
                        <div class="emoji">${item.icon || 'ğŸ±'}</div>
                        <div class="details">
                            <span class="shop-address">ğŸ  ${item.shop}</span>
                            <h3>${item.name}</h3>
                            <span class="coupon-tag">ğŸŸï¸ ${item.couponTitle || 'ã‚¯ãƒ¼ãƒãƒ³'}</span>
                            <div style="margin-top:5px;"><span style="text-decoration:line-through; color:#aaa;">${item.oldPrice}</span> â†’ <span style="font-weight:bold; color:red;">${item.newPrice}å††</span></div>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn-buy" onclick="handleBuy(this)">è²·ã„ãƒˆã‚¯ï¼</button>
                        <button class="btn-eat" onclick="handleEat(this)" disabled>ãŸã¹ã‚­ãƒªï¼</button>
                    </div>
                </div>
            `;
            document.getElementById('user-view').prepend(card);
            const marker = L.marker([item.lat, item.lng]).addTo(map).bindPopup(item.shop);
            markers.push({marker, card});
            if(isAuto) showBanner(`ğŸ”” æ–°ç€ï¼${item.shop}ã§${item.name}ãŒå‡ºå“ï¼`);
        }
        function showBanner(text) {
            const b = document.getElementById('notification-banner');
            document.getElementById('banner-text').innerText = text;
            b.style.top = "20px"; setTimeout(()=>b.style.top="-100px", 3000);
        }
        function handleBuy(btn) {
            if(currentKept >= 3 && !confirm("âš ï¸ è²·ã„ã™ãæ³¨æ„ï¼\næœ¬å½“ã«é£Ÿã¹ãã‚Œã¾ã™ã‹ï¼Ÿ")) return;
            const card = btn.closest('.card');
            card.classList.add('is-kept');
            card.querySelector('.btn-buy').style.display='none';
            card.querySelector('.btn-eat').disabled = false;
            currentKept++;
            showModal("ğŸ‰ ãƒ¬ã‚¹ã‚­ãƒ¥ãƒ¼å®Œäº†", "ã¾ã ç¢ºå®šã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\nç¾å‘³ã—ãé£Ÿã¹ãŸã‚‰ã€ŒãŸã¹ã‚­ãƒªï¼ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¯ãƒ¼ãƒãƒ³ã‚’GETã—ã¾ã—ã‚‡ã†ï¼");
        }
        function handleEat(btn) {
            const card = btn.closest('.card'); const item = card.itemData;
            const newCoupon = { id: Date.now(), shop: item.shop, title: item.couponTitle || "ç‰¹åˆ¥ã‚¯ãƒ¼ãƒãƒ³", saved: item.oldPrice - item.newPrice, exp: "æœ‰åŠ¹æœŸé™: 1é€±é–“ä»¥å†…" };
            myCoupons.push(newCoupon); localStorage.setItem('tb_coupons', JSON.stringify(myCoupons));
            card.remove(); currentKept--;
            renderCoupons(); switchTab('coupon');
            showModal("ğŸŸï¸ ã‚¯ãƒ¼ãƒãƒ³GET!", "å®Œé£Ÿã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼\nã€Œã‚¯ãƒ¼ãƒãƒ³ã€ã‚¿ãƒ–ã«è¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚");
        }
        function renderCoupons() {
            const list = document.getElementById('coupon-list'); list.innerHTML = "";
            if(myCoupons.length === 0) { list.innerHTML = "<p style='color:#aaa; margin-top:20px;'>ç¾åœ¨ã‚¯ãƒ¼ãƒãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“</p>"; return; }
            myCoupons.forEach((c, idx) => {
                const ticket = document.createElement('div'); ticket.className = 'ticket';
                ticket.innerHTML = `
                    <div class="ticket-info"><div class="ticket-shop">ğŸ  ${c.shop}</div><div class="ticket-offer">${c.title}</div><div class="ticket-exp">${c.exp}</div></div>
                    <button class="btn-use" onclick="promptUseCoupon(${idx})">ä½¿ã†</button>
                `;
                list.prepend(ticket);
            });
        }
        let targetCouponIdx = -1; let currentRating = 0;
        function promptUseCoupon(idx) {
            targetCouponIdx = idx; currentRating = 0; updateStars();
            const m = document.getElementById('modal');
            document.getElementById('modal-title').innerText = "ã‚¯ãƒ¼ãƒãƒ³ã‚’ä½¿ç”¨";
            document.getElementById('modal-text').innerText = "åº—å“¡ã•ã‚“ã«è¦‹ã›ã¦ãã ã•ã„";
            document.getElementById('qr-area').style.display = "block";
            document.getElementById('rating-stars').style.display = "none"; 
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById("qrcode"), {text: "USED-"+myCoupons[idx].id, width:150, height:150});
            const btn = document.getElementById('modal-btn');
            btn.innerText = "ä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹";
            btn.onclick = () => {
                document.getElementById('qr-area').style.display = "none";
                document.getElementById('modal-title').innerText = "è©•ä¾¡ã‚’ãŠé¡˜ã„ã—ã¾ã™";
                document.getElementById('modal-text').innerText = "ãŠåº—ã®å‘³ã‚„å¯¾å¿œã¯ã©ã†ã§ã—ãŸã‹ï¼Ÿ";
                document.getElementById('rating-stars').style.display = "block";
                btn.innerText = "é€ä¿¡ã—ã¦å®Œäº†";
                btn.onclick = finishRescue;
            };
            m.style.display = 'flex';
        }
        function setRating(n) { currentRating = n; updateStars(); }
        function updateStars() {
            const stars = document.querySelectorAll('#rating-stars span');
            stars.forEach((s, i) => { s.style.color = i < currentRating ? 'var(--gold)' : '#ddd'; });
        }
        function finishRescue() {
            if(currentRating === 0) { alert("æ˜Ÿã‚’é¸ã‚“ã§ãã ã•ã„ï¼"); return; }
            const coupon = myCoupons[targetCouponIdx];
            userStats.count++; userStats.money += coupon.saved; localStorage.setItem('tb_stats', JSON.stringify(userStats)); updateDashboard();
            myHistory.push({ shop: coupon.shop, title: coupon.title, date: new Date().toLocaleDateString(), rating: currentRating }); localStorage.setItem('tb_history', JSON.stringify(myHistory)); renderHistory();
            myCoupons.splice(targetCouponIdx, 1); localStorage.setItem('tb_coupons', JSON.stringify(myCoupons)); renderCoupons();
            // è‡ªåˆ†ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°
            renderRanking();
            closeModal(); alert("ãƒ¬ã‚¹ã‚­ãƒ¥ãƒ¼å®Œäº†ï¼\nå®Ÿç¸¾ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸï¼");
        }
        function renderHistory() {
            const list = document.getElementById('history-list'); list.innerHTML = "";
            myHistory.slice().reverse().forEach(h => {
                const stars = "â˜…".repeat(h.rating) + "â˜†".repeat(5-h.rating);
                list.innerHTML += `<div class="history-item"><div><div style="font-weight:bold;">${h.shop}</div><div style="font-size:12px; color:#666;">${h.title}ä½¿ç”¨</div></div><div style="text-align:right;"><div class="history-stars">${stars}</div><div class="history-date">${h.date}</div></div></div>`;
            });
        }
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
        }
        function showModal(title, text) {
            document.getElementById('modal-title').innerText = title; document.getElementById('modal-text').innerText = text;
            document.getElementById('qr-area').style.display="none"; document.getElementById('rating-stars').style.display="none";
            const btn = document.getElementById('modal-btn'); btn.innerText = "OK"; btn.onclick = closeModal;
            document.getElementById('modal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        function startAutoDemo() {
            const demoItems = [
                { shop: "ãƒ™ãƒ¼ã‚«ãƒªãƒ¼ãƒ»ãƒ‘ãƒ³å‰", name: "ã‚¯ãƒ­ãƒ¯ãƒƒã‚µãƒ³è©°ã‚åˆã‚ã›", oldPrice: 800, newPrice: 350, couponTitle:"ãƒ©ã‚¹ã‚¯1è¢‹", icon:"ğŸ¥", images: ["https://images.unsplash.com/photo-1555507036-ab1f40388085?w=500"] },
                { shop: "ã‚‰ãƒ¼ã‚ã‚“é“å ´", name: "ãƒãƒ£ãƒ¼ã‚·ãƒ¥ãƒ¼ä¸¼", oldPrice: 500, newPrice: 200, couponTitle:"ãƒˆãƒƒãƒ”ãƒ³ã‚°ç„¡æ–™", icon:"ğŸš", images: ["https://images.unsplash.com/photo-1569718212165-3a8278d5f624?w=500"] },
                { shop: "ã‚«ãƒ•ã‚§ãƒ»ãƒ©ãƒ†", name: "ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒBOX", oldPrice: 600, newPrice: 300, couponTitle:"ã‚³ãƒ¼ãƒ’ãƒ¼åŠé¡", icon:"ğŸ¥ª", images: ["https://images.unsplash.com/photo-1528735602780-2552fd46c7af?w=500"] }
            ];
            addProduct({...demoItems[0], lat:userLat, lng:userLng});
            setInterval(() => {
                const item = demoItems[Math.floor(Math.random() * demoItems.length)];
                const lat = userLat + (Math.random()-0.5)*0.01; const lng = userLng + (Math.random()-0.5)*0.01;
                addProduct({...item, lat, lng}, true);
            }, 8000);
        }
        let tapCount = 0;
        document.getElementById('app-header').addEventListener('click', () => {
            tapCount++; if(tapCount === 5) { if(prompt("Pass") === '0000') { document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.getElementById('admin-view').classList.add('active'); } tapCount = 0; }
        });
        let html5QrcodeScanner = null;
        function startScanner() {
            document.getElementById('scanner-modal').style.display = 'flex';
            if(html5QrcodeScanner) html5QrcodeScanner.clear();
            html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
            html5QrcodeScanner.render(onScanSuccess, ()=>{});
        }
        function onScanSuccess(txt) { alert("ç¢ºèªå®Œäº†: " + txt); stopScanner(); }
        function stopScanner() { document.getElementById('scanner-modal').style.display = 'none'; if(html5QrcodeScanner) html5QrcodeScanner.clear(); }
        function addNewProduct() {
            const shop = document.getElementById('input-shop').value; const name = document.getElementById('input-name').value;
            const couponTitle = document.getElementById('input-coupon-title').value; const oldP = document.getElementById('input-old').value; const newP = document.getElementById('input-new').value;
            if(!shop || !name) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
            addProduct({ shop, name, couponTitle, oldPrice:oldP, newPrice:newP, lat: userLat, lng: userLng, icon:"ğŸ" });
            alert("ç™»éŒ²ã—ã¾ã—ãŸ"); switchTab('home');
        }
    </script>
</body>
</html>
